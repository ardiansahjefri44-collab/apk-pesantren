<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- OPTIMASI MOBILE: Mencegah auto-zoom saat keyboard muncul -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#047857">
    <title>E-Santri Pro - Modern Dashboard</title>
    
    <link rel="manifest" href="manifest.json">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root { --primary: #047857; --secondary: #d97706; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-arabic { font-family: 'Amiri', serif; }

        /* Animations */
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin-icon { animation: spin 1s linear infinite; }

        /* Custom Scrollbar Halus */
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: transparent; }

        /* Input Autofill Fix Android */
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, textarea:-webkit-autofill, textarea:-webkit-autofill:hover, textarea:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0px 1000px #f8fafc inset;
            -webkit-text-fill-color: #334155;
            transition: background-color 5000s ease-in-out 0s;
        }
    </style>
</head>
<body class="h-screen flex text-slate-800 overflow-hidden relative">

    <!-- OVERLAY SIDEBAR (Gelap saat menu buka di Mobile/Drawer) -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden transition-opacity backdrop-blur-sm opacity-0"></div>

    <!-- LOGIN PAGE -->
    <div id="login-page" class="fixed inset-0 z-[100] flex items-center justify-center bg-emerald-900 p-4">
        <div class="absolute inset-0 z-[-1] bg-emerald-800/90"></div>
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-sm scale-in relative z-10">
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-emerald-700 text-white rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-quran text-4xl"></i>
                </div>
            </div>
            <h1 class="text-2xl font-bold text-center text-slate-800 mb-1">E-Santri Pro</h1>
            <p class="text-center text-emerald-600 font-medium mb-6 font-arabic text-lg">Pondok Pesantren Madani</p>
            
            <form id="login-form" class="space-y-5">
                <div class="relative">
                    <i class="fas fa-user absolute left-5 top-4.5 text-slate-400 text-lg"></i>
                    <!-- Touch Friendly Input -->
                    <input type="text" id="username" class="w-full pl-14 pr-4 py-4 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50 transition-colors text-lg" placeholder="Username" required>
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-5 top-4.5 text-slate-400 text-lg"></i>
                    <input type="password" id="password" class="w-full pl-14 pr-4 py-4 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50 transition-colors text-lg" placeholder="Password" required>
                </div>
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-2xl font-bold shadow-lg shadow-emerald-200 text-lg tracking-wide">MASUK</button>
                <p class="text-xs text-center text-slate-400 mt-2">Default: admin / 123</p>
            </form>
        </div>
    </div>

    <!-- SIDEBAR (MODERN DRAWER) -->
    <!-- Default hidden (-translate-x-full) agar saat login memberikan ruang penuh -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-full">
        <div class="p-6 flex items-center justify-between border-b border-slate-100 h-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-600 flex items-center justify-center rounded-xl text-white shadow-lg shadow-emerald-500/30">
                    <i class="fas fa-quran text-lg"></i>
                </div>
                <span class="font-bold text-xl tracking-tight text-slate-800">E-Santri<span class="text-emerald-600">Pro</span></span>
            </div>
            <!-- Tombol Close -->
            <button onclick="toggleSidebar()" class="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scroll">
            <button onclick="switchTab('dashboard')" class="nav-btn w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-emerald-50 hover:text-emerald-700 transition-all group font-medium" data-tab="dashboard">
                <div class="w-10 h-10 rounded-xl bg-slate-50 group-hover:bg-emerald-100 flex items-center justify-center transition-colors text-lg"><i class="fas fa-chart-pie"></i></div><span>Dashboard</span>
            </button>
            
            <!-- Data Santri Disembunyikan Menu Nya sesuai request -->
            <!-- <button onclick="switchTab('santri')" ... >Data Santri</button> -->

            <button onclick="switchTab('perizinan')" class="nav-btn w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-orange-50 hover:text-orange-600 transition-all group font-medium" data-tab="perizinan">
                <div class="w-10 h-10 rounded-xl bg-slate-50 group-hover:bg-orange-100 flex items-center justify-center transition-colors text-lg"><i class="fas fa-id-card-clip"></i></div><span>Perizinan</span>
            </button>
            
            <button onclick="switchTab('pelanggaran')" class="nav-btn w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-red-50 hover:text-red-600 transition-all group font-medium" data-tab="pelanggaran">
                <div class="w-10 h-10 rounded-xl bg-slate-50 group-hover:bg-red-100 flex items-center justify-center transition-colors text-lg"><i class="fas fa-exclamation-triangle"></i></div><span>Pelanggaran</span>
            </button>
            
            <div id="admin-nav" class="hidden pt-4 mt-4 border-t border-slate-100">
                <p class="px-4 text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Admin Area</p>
                <button onclick="switchTab('pengaturan')" class="nav-btn w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-500 hover:bg-slate-100 hover:text-slate-800 transition-all group font-medium" data-tab="pengaturan">
                    <div class="w-10 h-10 rounded-xl bg-slate-50 group-hover:bg-slate-200 flex items-center justify-center transition-colors text-lg"><i class="fas fa-cog"></i></div><span>Pengaturan</span>
                </button>
            </div>
        </nav>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-3 px-4 py-3.5 rounded-xl text-red-500 bg-white border border-red-100 hover:bg-red-50 transition-colors font-bold shadow-sm">
                <i class="fas fa-sign-out-alt w-5"></i><span>Keluar</span>
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT (Lebar Penuh karena Sidebar melayang/tersembunyi) -->
    <main class="flex-1 flex flex-col h-full w-full relative overflow-hidden bg-slate-50">
        
        <!-- Header Fixed -->
        <header class="h-20 bg-white shadow-sm border-b border-slate-200 px-4 flex items-center justify-between z-30 sticky top-0">
            <div class="flex items-center gap-4">
                <!-- Tombol Hamburger -->
                <button onclick="toggleSidebar()" class="p-3 -ml-3 bg-white text-slate-600 rounded-xl shadow-sm border border-slate-100 hover:bg-slate-50 transition-colors active:scale-95">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div>
                    <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
                    <p class="text-xs text-slate-400 font-medium">Sistem Manajemen Pesantren Terpadu</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 sm:gap-4">
                <!-- Sync Button -->
                <button onclick="manualSync()" id="btn-sync" class="flex items-center gap-2 px-4 py-2 rounded-2xl border border-slate-200 bg-white text-slate-600 font-bold text-xs transition-all shadow-sm hover:shadow-md relative">
                    <i class="fas fa-sync" id="icon-sync"></i>
                    <span class="hidden sm:inline" id="txt-sync">Synced</span>
                    <span id="badge-pending" class="hidden absolute -top-1 -right-1 flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-orange-500"></span>
                    </span>
                </button>
                
                <!-- User Profile -->
                <div class="flex items-center gap-3 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100">
                    <div class="w-9 h-9 bg-emerald-600 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-md">
                        <span id="user-initial">A</span>
                    </div>
                    <div class="hidden sm:block text-right pr-1">
                        <p id="user-display" class="text-sm font-bold text-slate-700 leading-tight">Admin</p>
                        <p id="pondok-display" class="text-[10px] text-emerald-600 font-bold uppercase tracking-wider">Pesantren Madani</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 pb-20 custom-scroll">
            
            <!-- DASHBOARD (Layout Responsif: 2 Kolom di HP, 4 di Desktop) -->
            <section id="tab-dashboard" class="tab-content space-y-6 max-w-7xl mx-auto">
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Kartu Total Santri -->
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center hover:shadow-md transition-shadow active:scale-95 duration-150">
                        <div class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-users text-xl"></i></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total</p>
                        <h3 class="text-3xl font-black text-slate-800" id="dash-total">0</h3>
                    </div>
                    <!-- Kartu Laki-laki -->
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center hover:shadow-md transition-shadow active:scale-95 duration-150">
                        <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-male text-xl"></i></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Laki-laki</p>
                        <h3 class="text-3xl font-black text-blue-600" id="dash-l">0</h3>
                    </div>
                    <!-- Kartu Perempuan -->
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center hover:shadow-md transition-shadow active:scale-95 duration-150">
                        <div class="w-14 h-14 bg-pink-50 text-pink-600 rounded-2xl flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-female text-xl"></i></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Perempuan</p>
                        <h3 class="text-3xl font-black text-pink-600" id="dash-p">0</h3>
                    </div>
                    <!-- Kartu Poin -->
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center hover:shadow-md transition-shadow active:scale-95 duration-150">
                        <div class="w-14 h-14 bg-red-50 text-red-600 rounded-2xl flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-exclamation-circle text-xl"></i></div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Poin</p>
                        <h3 class="text-3xl font-black text-red-600" id="dash-poin">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Chart Area -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-6"><h4 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-chart-bar text-emerald-500"></i> Analisis Poin Per Kamar</h4></div>
                        <div class="h-72 w-full"><canvas id="kamarChart"></canvas></div>
                    </div>
                    
                    <!-- Lists Area -->
                    <div class="space-y-6">
                        <div class="bg-gradient-to-br from-orange-50 to-white p-5 rounded-3xl shadow-sm border border-orange-100">
                            <h4 class="font-bold text-orange-700 mb-4 flex items-center gap-2"><i class="fas fa-walking"></i> Sedang Izin</h4>
                            <div class="space-y-3 max-h-48 overflow-y-auto custom-scroll" id="dash-izin-list"></div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-white p-5 rounded-3xl shadow-sm border border-red-100">
                            <h4 class="font-bold text-red-700 mb-4 flex items-center gap-2"><i class="fas fa-clock"></i> Santri Terlambat</h4>
                            <div class="space-y-3 max-h-48 overflow-y-auto custom-scroll" id="dash-late-list"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PERIZINAN -->
            <section id="tab-perizinan" class="tab-content space-y-6 max-w-7xl mx-auto hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button onclick="openIzinModal('biasa')" class="group bg-white p-8 rounded-3xl border border-slate-100 hover:border-orange-500 hover:shadow-xl transition-all flex flex-col items-center gap-4 active:scale-95 duration-150">
                        <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center text-3xl group-hover:scale-110 transition-transform shadow-sm"><i class="fas fa-walking"></i></div>
                        <div class="text-center"><h4 class="font-bold text-lg text-slate-700">Izin Biasa</h4><p class="text-xs text-slate-400">Input Individu</p></div>
                    </button>
                    <button onclick="openIzinModal('libur')" class="group bg-white p-8 rounded-3xl border border-slate-100 hover:border-blue-500 hover:shadow-xl transition-all flex flex-col items-center gap-4 active:scale-95 duration-150">
                        <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-3xl group-hover:scale-110 transition-transform shadow-sm"><i class="fas fa-plane-departure"></i></div>
                        <div class="text-center"><h4 class="font-bold text-lg text-slate-700">Libur Panjang</h4><p class="text-xs text-slate-400">Scan Massal</p></div>
                    </button>
                    <button onclick="openIzinModal('checkin')" class="group bg-white p-8 rounded-3xl border border-slate-100 hover:border-emerald-500 hover:shadow-xl transition-all flex flex-col items-center gap-4 active:scale-95 duration-150">
                        <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center text-3xl group-hover:scale-110 transition-transform shadow-sm"><i class="fas fa-user-check"></i></div>
                        <div class="text-center"><h4 class="font-bold text-lg text-slate-700">Check-In</h4><p class="text-xs text-slate-400">Kembalikan Santri</p></div>
                    </button>
                </div>

                <div class="bg-white rounded-3xl border border-slate-100 overflow-hidden shadow-sm">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h4 class="font-bold text-sm uppercase text-slate-500 tracking-wider">Riwayat Aktivitas</h4>
                        <button onclick="exportData('izin')" class="text-xs font-bold text-emerald-600 hover:underline">Export CSV</button>
                    </div>
                    <div class="divide-y max-h-[500px] overflow-y-auto custom-scroll" id="log-izin"></div>
                </div>
            </section>

            <!-- PELANGGARAN -->
            <section id="tab-pelanggaran" class="tab-content space-y-6 max-w-7xl mx-auto hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Form -->
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm h-fit">
                        <h4 class="font-bold mb-4 uppercase text-xs text-slate-500 tracking-wider">Input Pelanggaran</h4>
                        <form id="form-pelanggaran" class="space-y-4">
                            <div class="relative">
                                <label class="text-xs font-bold text-slate-400 ml-1">Cari / Ketik Santri</label>
                                <input type="text" list="list-santri-pel" id="p-nis-text" class="w-full p-3.5 border rounded-xl text-base bg-slate-50 outline-none focus:ring-2 focus:ring-red-500" placeholder="Nama / NIS..." required autocomplete="off">
                                <datalist id="list-santri-pel"></datalist>
                            </div>
                            <div><label class="text-xs font-bold text-slate-400 ml-1">Kamar</label><input type="text" id="p-kamar" class="w-full p-3.5 border rounded-xl text-base bg-slate-50 outline-none focus:ring-2 focus:ring-red-500" placeholder="Otomatis..." required></div>
                            <div><label class="text-xs font-bold text-slate-400 ml-1">Kategori</label><select id="p-kategori" onchange="updatePoinByKategori()" class="w-full p-3.5 border rounded-xl text-base bg-slate-50 outline-none focus:ring-2 focus:ring-red-500" required><option value="Ubudiyyah">Ubudiyyah</option><option value="Keamanan">Keamanan</option><option value="Maarif">Maarif</option></select></div>
                            <div><label class="text-xs font-bold text-slate-400 ml-1">Poin</label><input type="number" id="p-poin" class="w-full p-3.5 border rounded-xl text-base bg-slate-50 outline-none focus:ring-2 focus:ring-red-500" required></div>
                            <textarea id="p-ket" placeholder="Keterangan..." class="w-full p-3.5 border rounded-xl text-base h-24 bg-slate-50 outline-none focus:ring-2 focus:ring-red-500"></textarea>
                            <button type="button" onclick="submitPelanggaran()" class="w-full py-4 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-colors shadow-lg shadow-red-200 text-lg">SIMPAN DATA</button>
                        </form>
                    </div>

                    <!-- Table -->
                    <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-100 overflow-hidden shadow-sm flex flex-col">
                         <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-slate-50">
                            <h4 class="font-bold text-sm uppercase text-slate-500 tracking-wider">Daftar Pelanggaran</h4>
                            <div class="flex flex-wrap gap-2 items-center">
                                <input type="text" id="filter-pel-nama" oninput="renderPelanggaran()" placeholder="Cari Nama..." class="p-2.5 border rounded-lg text-xs w-32 outline-none">
                                <select id="filter-pel-asrama" onchange="renderPelanggaran()" class="p-2.5 border rounded-lg text-xs bg-white outline-none"><option value="">Semua</option></select>
                            </div>
                         </div>
                         <div class="px-4 py-3 bg-red-50 border-b border-red-100 flex justify-between items-center">
                            <span class="text-xs font-bold text-red-800">Total Poin (Filter):</span>
                            <span id="recap-poin" class="text-2xl font-black text-red-600">0</span>
                         </div>
                         <div class="overflow-x-auto flex-1"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50"><tr><th class="p-4">Santri</th><th class="p-4">Kamar</th><th class="p-4">Kategori</th><th class="p-4">Poin</th><th class="p-4">Tgl</th></tr></thead><tbody id="table-pelanggaran" class="divide-y divide-slate-100"></tbody></table></div>
                         <div class="p-4 border-t border-slate-100 flex justify-end">
                             <button onclick="exportData('pelanggaran')" class="text-xs font-bold text-white bg-slate-700 hover:bg-slate-800 px-4 py-2.5 rounded-lg flex items-center gap-2"><i class="fas fa-download"></i> Export</button>
                         </div>
                    </div>
                </div>
            </section>

            <!-- PENGATURAN -->
            <section id="tab-pengaturan" class="tab-content hidden space-y-6 max-w-7xl mx-auto">
                 <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <h4 class="font-bold mb-4 text-sm">Profil Pesantren</h4>
                    <input type="text" id="set-pondok" class="w-full p-3.5 border rounded-xl mb-3 bg-slate-50">
                    <button onclick="saveSettings()" class="px-6 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-200">Simpan Profil</button>
                </div>
                 <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <h4 class="font-bold mb-4 text-sm">Aturan Poin</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="text-xs text-slate-500 font-bold">Ubudiyyah</label><input type="number" id="set-poin-ubudiyyah" class="w-full p-2.5 border rounded-lg text-sm"></div>
                        <div><label class="text-xs text-slate-500 font-bold">Keamanan</label><input type="number" id="set-poin-keamanan" class="w-full p-2.5 border rounded-lg text-sm"></div>
                        <div><label class="text-xs text-slate-500 font-bold">Maarif</label><input type="number" id="set-poin-maarif" class="w-full p-2.5 border rounded-lg text-sm"></div>
                    </div>
                    <button onclick="saveSettings()" class="mt-4 px-6 py-3 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-700">Simpan Aturan</button>
                </div>
            </section>

        </div>
    </main>

    <!-- MODALS (Smart Izin & Santri) -->
    <div id="modal-smart-izin" class="fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-lg overflow-hidden shadow-2xl scale-in h-[90vh] sm:h-auto flex flex-col">
            <div id="smart-header" class="px-8 py-6 flex justify-between items-center text-white shrink-0">
                <h4 id="smart-title" class="font-bold text-xl">Form Perizinan</h4>
                <button onclick="closeSmartModal()" class="hover:rotate-90 transition-transform p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-8 space-y-6 overflow-y-auto custom-scroll flex-1">
                <div id="scanner-container" class="hidden space-y-3">
                    <div id="reader-global" class="rounded-2xl overflow-hidden bg-black aspect-video border-2 border-slate-200"></div>
                    <p class="text-xs text-center text-slate-400 font-bold uppercase tracking-widest">Arahkan Kamera</p>
                </div>

                <div id="smart-form-container">
                    <div class="space-y-5">
                        <div class="flex gap-3">
                            <input type="text" id="sm-nis" placeholder="NIS Santri / Scan..." class="flex-1 px-5 py-4 border-2 border-slate-100 rounded-2xl font-bold text-emerald-700 bg-emerald-50/50 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all text-lg">
                            <button type="button" id="btn-scan-toggle" onclick="toggleScanner()" class="px-6 bg-slate-800 text-white rounded-2xl shadow-lg hover:bg-slate-700 transition-colors shrink-0"><i class="fas fa-camera text-xl"></i></button>
                        </div>
                        
                        <div id="sm-info" class="p-4 rounded-xl text-sm font-semibold hidden"></div>
                        
                        <div id="area-biasa" class="hidden space-y-5">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold text-slate-400 ml-1">TGL KELUAR</label><input type="date" id="sm-tgl-out" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:border-emerald-500 outline-none"></div>
                                <div><label class="text-[10px] font-bold text-slate-400 ml-1">JAM KELUAR</label><input type="time" id="sm-jam-out" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:border-emerald-500 outline-none"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold text-slate-400 ml-1">BATAS KEMBALI</label><input type="date" id="sm-tgl-in" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:border-emerald-500 outline-none"></div>
                                <div><label class="text-[10px] font-bold text-slate-400 ml-1">JAM KEMBALI</label><input type="time" id="sm-jam-in" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:border-emerald-500 outline-none"></div>
                            </div>
                            <textarea id="sm-alasan" placeholder="Alasan Izin..." class="w-full p-4 border border-slate-200 rounded-xl text-sm h-24 focus:border-emerald-500 outline-none"></textarea>
                            <button id="sm-submit-biasa" class="w-full py-4 bg-orange-500 text-white font-black rounded-2xl shadow-xl shadow-orange-200 hover:bg-orange-600 transition-colors">PROSES IZIN</button>
                        </div>

                        <div id="area-libur" class="hidden space-y-5">
                            <div class="p-4 bg-blue-50 border border-blue-100 rounded-xl">
                                <p class="text-xs font-bold text-blue-600 uppercase mb-2">Masa Libur Massal</p>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="flex flex-col">
                                        <label class="text-[10px] font-bold text-slate-400">MULAI</label>
                                        <input type="date" id="lib-start" class="w-full p-2.5 border rounded-lg text-sm">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-[10px] font-bold text-slate-400">BERAKHIR</label>
                                        <input type="date" id="lib-end" class="w-full p-2.5 border rounded-lg text-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-slate-50 rounded-xl p-3 max-h-40 overflow-y-auto border border-slate-200 custom-scroll">
                                <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase text-center">Terinput Baru:</p>
                                <div id="libur-log-list" class="space-y-2"></div>
                            </div>
                        </div>

                        <div id="area-checkin" class="hidden space-y-5">
                            <div class="text-center py-4">
                                <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-2">
                                    <i class="fas fa-check"></i>
                                </div>
                                <p class="text-sm font-bold text-emerald-700">Auto Check-In Aktif</p>
                                <p class="text-xs text-slate-500">Scan/Input NIS untuk catat kembalinya santri.</p>
                            </div>
                            <div id="checkin-feedback" class="text-center p-3 rounded-xl hidden text-xs font-bold"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Santri (Hidden) -->
    <div id="modal-santri" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-md shadow-2xl scale-in">
            <h4 class="font-bold text-xl mb-6 text-slate-800">Data Santri</h4>
            <form id="form-santri" class="space-y-4">
                <input type="hidden" id="edit-id"> 
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="text-xs font-bold text-slate-400">Nama Lengkap</label><input type="text" id="s-nama" required class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></div>
                    <div><label class="text-xs font-bold text-slate-400">Gender</label><select id="s-gender" required class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 bg-white"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div>
                    <div><label class="text-xs font-bold text-slate-400">Tahun Masuk</label><input type="number" id="s-tahun" required class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></div>
                    <div class="col-span-2"><label class="text-xs font-bold text-slate-400">NIS</label><input type="text" id="s-nis" class="w-full px-4 py-3 border rounded-xl outline-none bg-slate-50 text-slate-500" readonly placeholder="Otomatis"></div>
                    <div><label class="text-xs font-bold text-slate-400">Asrama</label><input type="text" id="s-asrama" placeholder="Contoh: Al-Fatih" required class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></div>
                    <div class="col-span-2"><label class="text-xs font-bold text-slate-400">Nama Wali</label><input type="text" id="s-wali" placeholder="(Opsional)" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">Batal</button>
                    <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-200">SIMPAN</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl opacity-0 transition-all z-[200] font-medium text-sm pointer-events-none">Notifikasi</div>

    <script>
        // --- KONFIGURASI DATABASE ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyQRVgXrYFVg0Bc8lk3bcQyJSbD7zk1cy7IsSap7mhDG0QcKMbvVR3UTZXwF5ApwRE/exec";

        // Database & State
        let db = {
            santri: [{ id: 1, nama: "Ahmad Fauzan", nis: "1000", asrama: "Al-Fatih", gender: "L", tahunMasuk: 2023, status: "Aktif", wali: "Bapak Hasan", poin: 0 }, 
                     { id: 2, nama: "Siti Aisyah", nis: "1001", asrama: "Aisyah", gender: "P", tahunMasuk: 2022, status: "Bertugas", wali: "Ibu Siti", poin: 5 }],
            alumni: [], izin: [], pelanggaran: [], users: [{ user: 'admin', pass: '123', role: 'admin' }], settings: { pondok: "Pesantren Madani" },
            violationSettings: { Ubudiyyah: { poin: 5, jenis: ["Meninggalkan Shalat"] }, Keamanan: { poin: 20, jenis: ["Bolos"] }, Maarif: { poin: 5, jenis: ["Tidak Bawa Kitab"] } }
        };
        let currentUser = null, activeIzinType = '', html5QrCode = null, editingId = null, isProcessing = false;
        let isPendingSync = false;

        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) { console.log('SW Registered', registration); })
                    .catch(function(err) { console.log('SW Failed', err); });
            });
        }

        // --- SIDEBAR TOGGLE LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            // Cek Class: -translate-x-full = Tertutup, translate-x-0 = Terbuka
            const isClosed = sidebar.classList.contains('-translate-x-full');

            if (isClosed) {
                // Buka Sidebar
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                // Tutup Sidebar (Minimize)
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // --- DATABASE LOGIC ---
        async function saveDB() { 
            localStorage.setItem("esantri-db", JSON.stringify(db)); 
            if(SCRIPT_URL) {
                try {
                    updateSyncUI('syncing');
                    await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(db) });
                    isPendingSync = false;
                    updateSyncUI('success');
                } catch (error) {
                    isPendingSync = true;
                    updateSyncUI('pending');
                }
            }
        }

        async function loadDB() {
            if(SCRIPT_URL) {
                try {
                    const response = await fetch(SCRIPT_URL);
                    const data = await response.json();
                    if(data && Object.keys(data).length > 0) {
                        if(data.santri) db.santri = convertSheetDataToObjects(data.santri, db.santri[0]);
                        if(data.izin) db.izin = convertSheetDataToObjects(data.izin, db.izin[0]);
                        if(data.pelanggaran) db.pelanggaran = convertSheetDataToObjects(data.pelanggaran, db.pelanggaran[0]);
                        if(data.users) db.users = convertSheetDataToObjects(data.users, db.users[0]);
                        if(data.settings) db.settings = convertSheetDataToObjects(data.settings, db.settings);
                        if(data.violationSettings) db.violationSettings = convertSheetDataToObjects(data.violationSettings, db.violationSettings);
                        localStorage.setItem("esantri-db", JSON.stringify(db));
                        isPendingSync = false;
                        updateSyncUI('success');
                        return;
                    }
                } catch (error) {
                    updateSyncUI(isPendingSync ? 'pending' : 'offline');
                }
            }
            const data = localStorage.getItem("esantri-db");
            if (data) {
                const old = JSON.parse(data);
                db.santri = old.santri || []; db.alumni = old.alumni || []; db.izin = old.izin || []; db.pelanggaran = old.pelanggaran || [];
                db.users = (old.users && old.users.length > 0) ? old.users : db.users;
                db.settings = old.settings || db.settings;
                db.violationSettings = old.violationSettings || db.violationSettings;
            }
        }

        function convertSheetDataToObjects(sheetData, exampleObject) {
            if(!sheetData || sheetData.length === 0) return [];
            if(typeof sheetData[0] === 'object' && !Array.isArray(sheetData[0])) return sheetData;
            const keys = exampleObject ? Object.keys(exampleObject) : Object.keys(sheetData[0]);
            return sheetData.map(row => {
                let obj = {};
                keys.forEach((key, index) => {
                    let val = row[index];
                    if (typeof val === 'string' && (val.startsWith('{') || val.startsWith('['))) {
                        try { val = JSON.parse(val); } catch(e){}
                    }
                    obj[key] = val;
                });
                return obj;
            });
        }

        function updateSyncUI(status) {
            const btn = document.getElementById('btn-sync'); const icon = document.getElementById('icon-sync'); const txt = document.getElementById('txt-sync'); const badge = document.getElementById('badge-pending');
            if(status === 'syncing') {
                icon.className = "fas fa-sync spin-icon text-emerald-600"; txt.innerText = "Syncing..."; btn.classList.add('cursor-wait'); badge.classList.add('hidden');
            } else if(status === 'pending') {
                icon.className = "fas fa-exclamation-triangle text-orange-500"; txt.innerText = "Pending"; btn.classList.remove('cursor-wait'); badge.classList.remove('hidden');
            } else if(status === 'success') {
                icon.className = "fas fa-check text-emerald-600"; txt.innerText = "Synced"; btn.classList.remove('cursor-wait'); badge.classList.add('hidden');
            } else {
                icon.className = "fas fa-sync text-slate-400"; txt.innerText = "Offline"; btn.classList.remove('cursor-wait'); badge.classList.add('hidden');
            }
        }

        async function manualSync() {
            if(isPendingSync) {
                showToast("Sinkronisasi data pending...");
                try {
                    await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(db) });
                    isPendingSync = false;
                    updateSyncUI('success');
                    showToast("Sinkronisasi Berhasil!");
                } catch(e) { showToast("Gagal terhubung ke server."); }
            } else {
                showToast("Mengecek data terbaru...");
                await loadDB();
                initApp();
                showToast("Data diperbarui");
            }
        }

        window.addEventListener('online', () => {
            if(isPendingSync) { console.log("Back online..."); saveDB(); } else { updateSyncUI('success'); }
        });
        window.addEventListener('offline', () => { updateSyncUI('offline'); showToast("Anda sedang offline."); });

        // --- AUTH & INIT ---
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value, p = document.getElementById('password').value;
            const user = db.users.find(x => x.user === u && x.pass === p);
            if(user) { 
                currentUser = user; sessionStorage.setItem('esantri_session', JSON.stringify(user)); 
                document.getElementById('login-page').classList.add('hidden'); 
                
                // LOGIC BARU: Saat Login Sukses, Panggil ToggleSidebar() & Dashboard
                await initApp(); 
                toggleSidebar(); // Memastikan sidebar tertutup (karena default awalnya tertutup, ini menjaganya tetap tertutup)
            } else { showToast("Username atau Password salah!"); }
        };

        async function initApp() {
            await loadDB(); 
            document.getElementById('user-display').innerText = currentUser.user.toUpperCase();
            document.getElementById('user-initial').innerText = currentUser.user.charAt(0).toUpperCase();
            document.getElementById('admin-nav').style.display = currentUser.role === 'admin' ? 'block' : 'none';
            document.getElementById('pondok-display').innerText = db.settings.pondok;
            
            populateFilterAsrama();
            renderSantri(); renderIzinLog(); renderPelanggaran(); renderUsers(); renderDashboard(); initChart(); updateDashboard(); 
            populateFilterPelanggaranAsrama();
            renderSettings();
            updatePelanggaranFormOptions();
            populateSantriDatalist();
            
            switchTab('dashboard');
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('tab-'+t); if(target) target.classList.remove('hidden');
            
            // Reset Nav Style
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-emerald-50', 'text-emerald-700', 'bg-orange-50', 'text-orange-600', 'bg-red-50', 'text-red-600');
                const iconBox = btn.querySelector('div');
                if(iconBox) iconBox.className = "w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center transition-colors text-lg";
            });
            
            const navBtn = document.querySelector(`[data-tab="${t}"]`); 
            if(navBtn) {
                if(t === 'dashboard') {
                    navBtn.classList.add('bg-emerald-50', 'text-emerald-700');
                    navBtn.querySelector('div').classList.add('bg-emerald-100');
                } else if (t === 'perizinan') {
                    navBtn.classList.add('bg-orange-50', 'text-orange-600');
                    navBtn.querySelector('div').classList.add('bg-orange-100');
                } else if (t === 'pelanggaran') {
                    navBtn.classList.add('bg-red-50', 'text-red-600');
                    navBtn.querySelector('div').classList.add('bg-red-100');
                }
            }
            
            document.getElementById('page-title').innerText = t.charAt(0).toUpperCase() + t.slice(1);
            if(t === 'dashboard') { renderDashboard(); updateDashboard(); }

            // Tutup sidebar otomatis di Mobile saat ganti tab
            if(window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const izinList = document.getElementById('dash-izin-list'); const onLeave = db.santri.filter(s => s.status !== 'Aktif' && s.status !== 'Alumni');
            izinList.innerHTML = onLeave.length ? '' : '<p class="text-xs text-center text-slate-400 py-2">Tidak ada santri izin.</p>';
            onLeave.forEach(s => {
                const lastIzin = db.izin.filter(i => i.sid === s.id && i.status === 'Pulang').pop();
                const detail = lastIzin ? lastIzin.detail.split('|')[1].trim() : '-'; 
                izinList.innerHTML += `<div class="flex items-center justify-between p-3 bg-white rounded-xl shadow-sm border border-orange-50"><div><p class="font-bold text-sm text-slate-700">${s.nama}</p><p class="text-[10px] text-orange-500 font-semibold">Kembali: ${detail.replace('Kembali: ', '')}</p></div><div class="w-2 h-2 rounded-full bg-orange-500"></div></div>`;
            });

            const lateList = document.getElementById('dash-late-list'); const today = new Date().toISOString().split('T')[0]; const lateStudents = [];
            db.izin.forEach(i => { if (i.status === 'Pulang' && i.detail.includes('Kembali:')) { const returnDateStr = i.detail.split('Kembali:')[1].trim(); if (returnDateStr < today) { const s = db.santri.find(san => san.id === i.sid); if (s && s.status !== 'Aktif') { lateStudents.push({ ...s, returnDate: returnDateStr }); } } } });
            lateList.innerHTML = lateStudents.length ? '' : '<p class="text-xs text-center text-slate-400 py-2">Aman, tidak ada santri terlambat.</p>';
            lateStudents.forEach(s => {
                lateList.innerHTML += `<div class="flex items-center justify-between p-3 bg-white rounded-xl shadow-sm border border-red-50"><div><p class="font-bold text-sm text-slate-700">${s.nama}</p><p class="text-[10px] text-red-500">Lewat: ${s.returnDate}</p></div><i class="fas fa-exclamation text-red-400"></i></div>`;
            });
        }
        function updateDashboard() {
            document.getElementById('dash-total').innerText = db.santri.length;
            document.getElementById('dash-l').innerText = db.santri.filter(s => s.gender === 'L').length;
            document.getElementById('dash-p').innerText = db.santri.filter(s => s.gender === 'P').length;
            document.getElementById('dash-poin').innerText = db.santri.reduce((a,b) => a + (b.poin || 0), 0);
        }

        // --- PERIZINAN ---
        function openIzinModal(type) {
            activeIzinType = type;
            const modal = document.getElementById('modal-smart-izin'); const header = document.getElementById('smart-header');
            document.getElementById('area-biasa').classList.add('hidden'); document.getElementById('area-libur').classList.add('hidden'); document.getElementById('area-checkin').classList.add('hidden');
            document.getElementById('sm-info').classList.add('hidden'); document.getElementById('sm-nis').value = ''; document.getElementById('checkin-feedback').classList.add('hidden'); document.getElementById('libur-log-list').innerHTML = '';
            
            if(type === 'biasa') {
                document.getElementById('smart-title').innerText = "IZIN BIASA";
                header.className = "px-8 py-6 flex justify-between items-center text-white bg-orange-500";
                document.getElementById('area-biasa').classList.remove('hidden');
            } else if(type === 'libur') {
                document.getElementById('smart-title').innerText = "LIBUR PANJANG";
                header.className = "px-8 py-6 flex justify-between items-center text-white bg-blue-500";
                document.getElementById('area-libur').classList.remove('hidden');
            } else {
                document.getElementById('smart-title').innerText = "CHECK-IN SANTRI";
                header.className = "px-8 py-6 flex justify-between items-center text-white bg-emerald-500";
                document.getElementById('area-checkin').classList.remove('hidden');
            }
            modal.classList.remove('hidden');
        }

        function closeSmartModal() { stopScanner(); document.getElementById('modal-smart-izin').classList.add('hidden'); }

        function toggleScanner() {
            const container = document.getElementById('scanner-container');
            if(container.classList.contains('hidden')) {
                container.classList.remove('hidden'); document.getElementById('btn-scan-toggle').innerHTML = '<i class="fas fa-stop"></i>';
                try {
                    html5QrCode = new Html5Qrcode("reader-global");
                    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                        if(!isProcessing) {
                            isProcessing = true;
                            document.getElementById('sm-nis').value = txt;
                            handlePerizinanInput(txt);
                            setTimeout(() => isProcessing = false, 1500);
                        }
                    });
                } catch (err) { showToast("Kamera error"); stopScanner(); }
            } else { stopScanner(); }
        }

        function stopScanner() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').classList.add('hidden');
                    document.getElementById('btn-scan-toggle').innerHTML = '<i class="fas fa-camera text-xl"></i>';
                    html5QrCode = null;
                }).catch(err => {});
            }
        }

        document.getElementById('sm-nis').addEventListener('keydown', (e) => { if(e.key === 'Enter') { handlePerizinanInput(e.target.value); } });
        document.getElementById('sm-nis').oninput = (e) => { if(activeIzinType === 'biasa') lookupSantri(e.target.value); };

        function handlePerizinanInput(nis) {
            const santri = db.santri.find(s => s.nis === nis);
            const info = document.getElementById('sm-info');
            if(!santri) { info.innerText = "NIS tidak ditemukan!"; info.className = "p-4 bg-red-50 text-red-700 rounded-xl text-sm font-semibold block border border-red-100"; return; }
            if(activeIzinType === 'biasa') {
                info.innerText = `Santri: ${santri.nama} | ${santri.asrama}`;
                info.className = "p-4 bg-emerald-50 text-emerald-700 rounded-xl text-sm font-semibold block border border-emerald-100";
            } else if(activeIzinType === 'libur') {
                if(santri.status === 'Libur') showToast(`${santri.nama} sudah libur!`); else processLiburAuto(santri);
            } else if(activeIzinType === 'checkin') {
                if(santri.status === 'Aktif') showToast(`${santri.nama} sudah aktif di pondok.`); else processCheckInAuto(santri);
            }
        }

        function lookupSantri(nis) {
            const santri = db.santri.find(s => s.nis === nis);
            const info = document.getElementById('sm-info');
            if(santri) { info.innerText = `Santri: ${santri.nama} | Kamar: ${santri.asrama} | Status: ${santri.status}`; info.className = "p-4 bg-emerald-50 text-emerald-700 rounded-xl text-sm font-semibold block border border-emerald-100"; }
            else { info.innerText = "NIS tidak ditemukan!"; info.className = "p-4 bg-red-50 text-red-700 rounded-xl text-sm font-semibold block border border-red-100"; }
        }

        document.getElementById('sm-submit-biasa').onclick = async () => {
            const nis = document.getElementById('sm-nis').value; const santri = db.santri.find(s => s.nis === nis);
            if(!santri) return showToast("Pilih Santri Terlebih Dahulu");
            santri.status = "Izin";
            const record = { id: Date.now(), sid: santri.id, nama: santri.nama, tgl: new Date().toLocaleDateString('id-ID'), status: 'Pulang', tipe: "Izin Biasa", detail: `Keluar: ${document.getElementById('sm-tgl-out').value} | Kembali: ${document.getElementById('sm-tgl-in').value}` };
            db.izin.push(record); await saveDB(); await initApp(); closeSmartModal(); showToast("Izin Biasa dicatat!");
        };

        async function processLiburAuto(santri) {
            const start = document.getElementById('lib-start').value; const end = document.getElementById('lib-end').value;
            if(!start || !end) return showToast("Isi tanggal masa libur dulu!");
            santri.status = "Libur";
            const record = { id: Date.now(), sid: santri.id, nama: santri.nama, tgl: new Date().toLocaleDateString('id-ID'), status: 'Pulang', tipe: "Libur Panjang", detail: `Mulai: ${start} | End: ${end}` };
            db.izin.push(record); await saveDB();
            const log = document.getElementById('libur-log-list');
            log.innerHTML = `<div class="flex justify-between text-xs border-b border-slate-200 pb-1"><span>${santri.nama}</span><span class="text-emerald-600 font-bold">Berhasil</span></div>` + log.innerHTML;
            document.getElementById('sm-nis').value = ''; showToast(`${santri.nama} Masuk Libur`);
        }

        async function processCheckInAuto(santri) {
            const activeIzin = db.izin.filter(i => i.sid === santri.id && i.status === 'Pulang').pop();
            if(!activeIzin) return showToast("Data izin tidak ditemukan.");
            santri.status = "Aktif";
            const record = { id: Date.now(), sid: santri.id, nama: santri.nama, tgl: new Date().toLocaleDateString('id-ID'), status: 'Kembali', tipe: activeIzin.tipe, detail: `Santri kembali ke pondok (${activeIzin.tipe})` };
            db.izin.push(record); await saveDB();
            const fb = document.getElementById('checkin-feedback');
            fb.innerHTML = `<span class="text-emerald-700">${santri.nama} Check-In (${activeIzin.tipe}) Berhasil!</span>`;
            fb.className = "text-center p-3 rounded-xl bg-emerald-50 text-xs font-bold block border border-emerald-100 animate-pulse";
            document.getElementById('sm-nis').value = '';
        }

        function renderIzinLog() {
            const log = document.getElementById('log-izin'); log.innerHTML = '';
            [...db.izin].reverse().forEach(i => {
                log.innerHTML += `<div class="p-4 flex justify-between items-center text-sm hover:bg-slate-50"><div><p class="font-bold text-slate-700">${i.nama} <span class="text-[10px] uppercase text-slate-400 ml-2 px-2 py-0.5 bg-slate-100 rounded-full">${i.tipe}</span></p><p class="text-[10px] text-slate-400 mt-1">${i.detail}</p></div><div class="text-[10px] font-bold px-2 py-1 rounded ${i.status==='Kembali'?'bg-emerald-100 text-emerald-600':'bg-orange-100 text-orange-600'}">${i.status.toUpperCase()}</div></div>`;
            });
        }

        // --- PELANGGARAN ---
        function populateSantriDatalist() {
            const dl = document.getElementById('list-santri-pel');
            dl.innerHTML = db.santri.map(s => `<option value="${s.nama} (${s.nis})" data-nis="${s.nis}" data-asrama="${s.asrama}">`).join('');
        }

        function updatePelanggaranFormOptions() {
            const kategori = document.getElementById('p-kategori').value;
            const settings = db.violationSettings[kategori] || { poin: 5 };
            document.getElementById('p-poin').value = settings.poin;
        }

        document.getElementById('p-nis-text').addEventListener('change', function() {
            const val = this.value;
            const santri = db.santri.find(s => s.nis === val || s.nama.toLowerCase() === val.toLowerCase());
            if(santri) document.getElementById('p-kamar').value = santri.asrama;
        });

        function populateFilterPelanggaranAsrama() {
            const asramas = [...new Set(db.santri.map(s => s.asrama))];
            const sel = document.getElementById('filter-pel-asrama');
            sel.innerHTML = '<option value="">Semua Kamar</option>' + asramas.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function renderPelanggaran() {
            const fKat = document.getElementById('filter-pel-kategori').value;
            const fKamar = document.getElementById('filter-pel-asrama').value;
            const qNama = document.getElementById('filter-pel-nama').value.toLowerCase();
            
            const body = document.getElementById('table-pelanggaran'); body.innerHTML = '';

            let filtered = db.pelanggaran.filter(p => {
                const s = db.santri.find(x => x.id == p.sid);
                const matchKat = fKat === "" || p.kategori === fKat;
                const matchKamar = fKamar === "" || (s && s.asrama === fKamar) || p.kamar === fKamar;
                const matchNama = qNama === "" || (s && s.nama.toLowerCase().includes(qNama)) || (p.nama && p.nama.toLowerCase().includes(qNama));
                return matchKat && matchKamar && matchNama;
            });

            const totalPoin = filtered.reduce((acc, curr) => acc + (curr.poin || 0), 0);
            document.getElementById('recap-poin').innerText = totalPoin;

            filtered.forEach(p => {
                body.innerHTML += `<tr class="hover:bg-red-50"><td class="p-4 font-bold text-slate-700">${p.nama}</td><td class="p-4 text-xs font-bold text-slate-600">${p.kamar}</td><td class="p-4 text-xs font-bold uppercase text-slate-500">${p.kategori}</td><td class="p-4 font-black text-red-600">${p.poin}</td><td class="p-4 text-[10px] text-slate-400">${p.tgl}</td></tr>`;
            });
        }

        async function submitPelanggaran() {
            const inputVal = document.getElementById('p-nis-text').value;
            const santri = db.santri.find(s => s.nis === inputVal || s.nama.toLowerCase() === inputVal.toLowerCase());
            
            if(!santri) return showToast("Santri tidak ditemukan!");

            const kategori = document.getElementById('p-kategori').value;
            const poin = Number(document.getElementById('p-poin').value);
            const ket = document.getElementById('p-ket').value;
            const kamar = document.getElementById('p-kamar').value;

            santri.poin = (santri.poin || 0) + poin;
            db.pelanggaran.push({ 
                id: Date.now(), 
                sid: santri.id, 
                nama: santri.nama, 
                kategori: kategori,
                kamar: kamar, 
                poin: poin, 
                ket: ket, 
                tgl: new Date().toLocaleDateString('id-ID') 
            });
            
            await saveDB(); await initApp(); showToast("Pelanggaran tercatat");
            document.getElementById('form-pelanggaran').reset();
            updatePelanggaranFormOptions();
        }

        // --- SANTRI FUNCTIONS ---
        function populateFilterAsrama() { const asramas = [...new Set(db.santri.map(s => s.asrama))]; const sel = document.getElementById('filter-asrama'); if(sel) sel.innerHTML = '<option value="">Semua Asrama</option>' + asramas.map(a => `<option value="${a}">${a}</option>`).join(''); }
        function renderSantri() { /* Tab Santri Disembunyikan */ }
        function openModal(id) { /* ... */ }
        function closeModal() { document.getElementById('modal-santri').classList.add('hidden'); }

        // --- PENGATURAN & USERS ---
        function renderSettings() {
            document.getElementById('set-pondok').value = db.settings.pondok || '';
            document.getElementById('set-poin-ubudiyyah').value = db.violationSettings.Ubudiyyah.poin;
            document.getElementById('set-poin-keamanan').value = db.violationSettings.Keamanan.poin;
            document.getElementById('set-poin-maarif').value = db.violationSettings.Maarif.poin;
        }

        async function saveSettings() {
            db.settings.pondok = document.getElementById('set-pondok').value;
            db.violationSettings.Ubudiyyah.poin = Number(document.getElementById('set-poin-ubudiyyah').value);
            db.violationSettings.Keamanan.poin = Number(document.getElementById('set-poin-keamanan').value);
            db.violationSettings.Maarif.poin = Number(document.getElementById('set-poin-maarif').value);
            await saveDB(); await initApp(); showToast("Pengaturan Tersimpan!");
        }

        function renderUsers() { /* ... */ }
        function populateSelects() { /* ... */ }
        function addUser() { /* ... */ }
        function delUser(u) { /* ... */ }
        function delSantri(id) { /* ... */ }
        function logout() { sessionStorage.removeItem('esantri_session'); location.reload(); }
        
        let chart = null; 
        function initChart() {
            const ctx = document.getElementById('kamarChart').getContext('2d'); const kamars = {}; db.santri.forEach(s => kamars[s.asrama] = (kamars[s.asrama] || 0) + s.poin);
            if(chart) chart.destroy();
            chart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(kamars), datasets: [{ label: 'Total Poin', data: Object.values(kamars), backgroundColor: '#ef4444', borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
        }
        function exportData(type) {
            if(type === 'pelanggaran') {
                let filtered = db.pelanggaran;
                const fKat = document.getElementById('filter-pel-kategori').value; const fKamar = document.getElementById('filter-pel-asrama').value; const qNama = document.getElementById('filter-pel-nama').value.toLowerCase();
                filtered = filtered.filter(p => {
                    const s = db.santri.find(x => x.id == p.sid);
                    const matchKat = fKat === "" || p.kategori === fKat;
                    const matchKamar = fKamar === "" || (s && s.asrama === fKamar) || p.kamar === fKamar;
                    const matchNama = qNama === "" || (s && s.nama.toLowerCase().includes(qNama)) || (p.nama && p.nama.toLowerCase().includes(qNama));
                    return matchKat && matchKamar && matchNama;
                });
                if(filtered.length === 0) return showToast("Tidak ada data untuk di-export");
                let csv = "Nama,Kamar,Kategori,Poin,Tanggal\n";
                filtered.forEach(d => { csv += `${d.nama},${d.kamar},${d.kategori},${d.poin},${d.tgl}\n`; });
                downloadCSV(csv, `rekap_pelanggaran_${Date.now()}.csv`);
                return;
            }
            if(type === 'izin') { let csv = 'Nama,Tipe,Detail,Status,Tanggal\n'; const data = db.izin; if(data.length === 0) return showToast("Tidak ada data"); data.forEach(d => { csv += `${d.nama},${d.tipe},${d.detail},${d.status},${d.tgl}\n`; }); downloadCSV(csv, `rekap_izin_${Date.now()}.csv`); }
        }
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.remove('opacity-0', 'translate-y-4'); t.classList.add('opacity-100', '-translate-y-4'); setTimeout(() => { t.classList.remove('opacity-100', '-translate-y-4'); t.classList.add('opacity-0', 'translate-y-4'); }, 3000); }

        window.onload = async () => { 
            const session = sessionStorage.getItem('esantri_session'); 
            if(session) { 
                currentUser = JSON.parse(session); 
                document.getElementById('login-page').classList.add('hidden'); 
                await initApp(); 
            } 
        };
    </script>
</body>
</html>
